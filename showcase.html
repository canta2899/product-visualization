<!DOCTYPE html>
<html lang="en">
<head>
    <title>Showcase</title>
    
    <!-- Meta and links -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">

    <style>
        body{
            overflow: hidden;
        }
    </style>

    <!-- Bootstrap -->
    <script src="libs/jquery.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>

    <!--ThreeJS-->
    <script src="libs/three.js"></script>
    <script src="libs/stats.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/OBJLoader.js"></script>
    

	<!--Vertex shader-->
	<script type="text/x-glsl" id="vertex">
		attribute vec4 tangent;
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec3 wPosition;
		varying vec3 vTangent;
		varying vec3 vBitangent;
		varying vec2 vUv;
		
		void main() {
			vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
			vPosition = vPos.xyz;
			wPosition = (modelMatrix * vec4( position, 1.0 )).xyz;
			vNormal = normalize(normalMatrix * normal);
			vec3 objectTangent = vec3( tangent.xyz );
			vec3 transformedTangent = normalMatrix * objectTangent;
			vTangent = normalize( transformedTangent );
			vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
			vUv = uv;
			gl_Position = projectionMatrix * vPos;
		}
		

	</script>

	<!--Fragment shader-->
	<script type="text/x-glsl" id="fragment">
		varying vec3 vNormal;
		varying vec3 vTangent;
		varying vec3 vBitangent;
		varying vec3 vPosition;
		varying vec3 wPosition;
		varying vec2 vUv;
		uniform vec3 pointLightPosition;
		uniform vec3 clight;
		uniform sampler2D specularMap;
		uniform sampler2D diffuseMap;
		uniform sampler2D roughnessMap;
		uniform sampler2D normalMap;
		uniform samplerCube envMap;
		uniform vec2 normalScale;
		uniform vec2 textureRepeat;
		const float PI = 3.14159;
		
		vec3 cdiff;
		vec3 cspec;
		float roughness;
		
		vec3 FSchlick(float vDoth, vec3 f0) {
			return f0 + (vec3(1.0)-f0)*pow(1.0 - vDoth,5.0);
		}
		
		float DGGX(float NoH, float alpha) {
			float alpha2 = alpha * alpha;
			float k = NoH*NoH * (alpha2 - 1.0) + 1.0;
			return alpha2 / (PI * k * k );
		}
		
		float G1(float nDotv, float alpha) {
			float alpha2 = alpha*alpha;
			return 2.0 * (nDotv / (nDotv + sqrt(alpha2 + (1.0-alpha2)*nDotv*nDotv )));
		}
		
		float GSmith(float nDotv, float nDotl, float alpha) {
			return G1(nDotl,alpha)*G1(nDotv,alpha);
		}
		
		vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
			return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
		}
		
		void main() {
			vec4 lPosition = viewMatrix * vec4(pointLightPosition, 1.0);
			vec3 l = normalize(lPosition.xyz - vPosition.xyz);
			vec3 v = normalize(-vPosition);
			vec3 h = normalize(v + l);
			vec3 normal = normalize( vNormal );
			vec3 tangent = normalize( vTangent );
			vec3 bitangent = normalize( vBitangent );
			mat3 vTBN = mat3( tangent, bitangent, normal );
			vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
			mapN.xy = normalScale * mapN.xy;
			vec3 n = normalize( vTBN * mapN );
			vec3 worldN = inverseTransformDirection( n, viewMatrix );
			vec3 worldV = cameraPosition - wPosition ;
			vec3 r = normalize( reflect(-worldV,worldN));
			roughness = texture2D( roughnessMap, vUv*textureRepeat).r;
			float alpha = roughness * roughness;
			float nDotl = max(dot(n, l), 0.000001);
			float lDoth = max(dot(l, h), 0.000001);
			float nDoth = max(dot(n, h), 0.000001);
			float vDoth = max(dot(v, h), 0.000001);
			float nDotv = max(dot(n, v), 0.000001);
		
			vec3 envLight = textureCube( envMap, r).rgb;
			envLight = pow( envLight, vec3(2.2)); // linearizzo la texture
		
			cdiff = texture2D( diffuseMap, vUv*textureRepeat ).rgb;
			cdiff = pow( cdiff, vec3(2.2)); // linearizzo la texture
		
			cdiff = texture2D(diffuseMap, vUv*textureRepeat).rgb;
			// texture in sRGB, linearize
			cdiff = pow(cdiff, vec3(2.2));
			cspec = texture2D(specularMap, vUv*textureRepeat).rgb;
			// texture in sRGB, linearize
			cspec = pow(cspec, vec3(2.2));
			vec3 fresnel = FSchlick(vDoth, cspec);
			vec3 BRDF = (vec3(1.0)-fresnel)*cdiff/PI + fresnel*GSmith(nDotv, nDotl, alpha)*DGGX(nDoth, alpha)/
			(4.0*nDotl*nDotv);
			vec3 outRadiance = PI * clight * nDotl * BRDF;
			// gamma encode the final value
			gl_FragColor = vec4(pow(outRadiance, vec3(1.0/2.2)), 1.0);
		}
	</script>
</head>

<body>
	<!-- Three js code-->
	<script type="module" src="./code.js"></script>

	<!-- Header code-->
    <div id="header"></div>
    
	<canvas></canvas> <!-- Canvas for Threejs scene-->

	<!-- Menu -->
    <div class="shadow p-3 mb-5 bg-white rounded controls">
		<h1>Info</h1>
		<hr/>
        Scegli una colorazione
		<select class="form-select" aria-label="Default select example">
			<option selected value="1">One</option>
			<option value="2">Two</option>
			<option value="3">Three</option>
		  </select>
		  

        <hr/>

        Scegli una patata
		<select class="form-select" aria-label="Default select example">
			<option selected value="1">One</option>
			<option value="2">Two</option>
			<option value="3">Three</option>
		  </select>

		<hr/>
		  
		<p><strong>Prezzo</strong>: TANTI â‚¬ </p>

		<button type="button" class="btn btn-secondary">Chiudi</button>
		  
    </div>

	<!-- Menu button -->
	<div id="menu">
		<button type="button" class="btn btn-light">Menu</button>
	</div>

	<!-- Functions to load components and interact with menu-->
    <script>

		var controls = false;
        
        function loadMainPage(){
            $("#header").load("header.html")
            $(".controls").hide();
        }

		$("#dropdown").click(function(){
			$(".content").fadeIn("slow");
		})
        
        $(document).ready(function(){$("canvas").hide().fadeIn(1000);});
        

		$("#menu > button").click(function(){
			if (!controls){
				$(".controls").fadeIn("fast");
				controls = true;
				$("#menu").hide();
			}
		})

		$(".controls > button").click(function(){
			if(controls){
				$(".controls").fadeOut("fast");
				controls = false;
				$("#menu").fadeIn("fast");
			}
		})

        loadMainPage(); 
    </script>

</body>
</html>